# LipSync Generator 积分消耗优化方案

## 📊 **优化前后对比**

### **优化前（固定积分扣费）**
- **lipsync模型**: 固定25积分
- **lipsync_fast模型**: 固定15积分
- **问题**: 不管生成的视频多长，都扣除固定积分，用户体验不佳

### **优化后（前扣除+后调整混合模式）**
- **前扣除**: 生成开始时按估算时长扣除积分
- **后调整**: 生成完成后按实际时长多退少补
- **计算公式**: `estimated_duration_seconds * resolution_multiplier`
- **分辨率倍数**: 540p = 1倍积分，720p = 2倍积分
- **优势**: 用户可预知消耗 + 最终按实际内容付费 + 避免生成中断

## 🔧 **技术实现**

### **1. 数据库层面**
- **创建项目时**: 不扣除积分，只检查最低积分要求
- **视频完成后**: 调用`deduct_lipsync_credits_by_duration`按时长扣费
- **积分不足处理**: 扣除所有剩余积分，不阻止视频完成

### **2. 前端层面**
- **动态积分估算**: 根据音频时长和模型选择实时计算
- **模型选择UI**: 用户可选择高质量或快速模式
- **限制计算**: 基于用户积分动态计算最大音频时长和文本长度

### **3. API层面**
- **项目创建**: 使用优化后的`create_lipsync_project` RPC
- **Webhook处理**: 视频完成后自动按时长扣费

## 📋 **核心RPC函数**

### **create_lipsync_project_with_credit_deduction**
```sql
-- 创建项目并前扣除积分（基于估算时长）
-- 参数：p_user_id, p_job_id, p_estimated_duration_seconds, etc.
-- 计算：estimated_duration_seconds * resolution_multiplier
-- 返回：job_id, status, credits_deducted
-- 状态：processing, user_not_found, insufficient_credits, concurrent_generation_exists
```

### **adjust_lipsync_credits_by_actual_duration**
```sql
-- 按实际视频时长调整积分（多退少补）
-- 参数：p_job_id, p_duration_ms
-- 计算：actual_credits_needed - credits_already_deducted
-- 正数=额外扣除，负数=退还积分
```

## 💰 **积分计算示例（前扣除+后调整）**

### **场景1: 文本输入估算8秒，实际生成10秒，720p分辨率**
- **前扣除**: `8 * 2 = 16积分`
- **实际需要**: `10 * 2 = 20积分`
- **后调整**: `20 - 16 = +4积分`（额外扣除4积分）
- **最终消耗**: `20积分`

### **场景2: 音频上传12秒，实际生成10秒，540p分辨率**
- **前扣除**: `12 * 1 = 12积分`
- **实际需要**: `10 * 1 = 10积分`
- **后调整**: `10 - 12 = -2积分`（退还2积分）
- **最终消耗**: `10积分`

### **场景3: 录音5秒，实际生成5秒，720p分辨率**
- **前扣除**: `5 * 2 = 10积分`
- **实际需要**: `5 * 2 = 10积分`
- **后调整**: `10 - 10 = 0积分`（无需调整）
- **最终消耗**: `10积分`

## 🎯 **用户体验改进**

### **前端优化**
1. **实时积分估算**: 根据输入内容动态显示预估积分
2. **模型选择**: 清晰显示两种模型的质量和积分差异
3. **限制提示**: 基于用户积分显示最大可用时长
4. **详细说明**: 显示积分计算方式和模型倍数

### **新增功能**
1. **Video Resolution选择**: 540p (标准) / 720p (2倍积分)
2. **Aspect Ratio选择**: 9:16 (竖屏) / 1:1 (方形) / 16:9 (横屏)
3. **实时积分估算**: 根据分辨率选择动态计算
4. **完全匹配AI Baby Podcast**: 使用相同的UI设计和积分逻辑

### **积分限制逻辑**
- **最大录音时长**: `floor(credits / resolution_multiplier)` 秒
- **最大音频时长**: `floor(credits / resolution_multiplier)` 秒
- **最大文本长度**: `credits * 15` 字符（与AI Baby Podcast一致）

## 🔄 **工作流程**

### **1. 用户提交请求**
```
用户选择模型 → 上传文件/输入文本 → 前端估算积分 → 提交请求
```

### **2. 后端处理**
```
检查最低积分 → 创建项目记录 → 发送到N8N → 返回jobId
```

### **3. N8N处理**
```
生成视频 → 获取视频时长 → 回调webhook → 按时长扣费 → 更新状态
```

### **4. 用户获取结果**
```
轮询状态 → 获取视频URL → 查看实际消耗积分
```

## 📈 **业务优势**

### **用户角度**
- ✅ 按实际使用付费，更加公平
- ✅ 可选择质量和速度平衡
- ✅ 透明的积分计算方式
- ✅ 实时的积分估算

### **平台角度**
- ✅ 更精确的成本控制
- ✅ 提高用户满意度
- ✅ 减少积分浪费
- ✅ 灵活的定价策略

## 🚀 **部署步骤**

### **1. 数据库更新**
```bash
# 在Supabase中执行
psql -f database/07_lipsync_generations.sql
```

### **2. 前端部署**
- 更新的组件已包含模型选择和动态积分计算
- 支持实时积分估算和限制提示

### **3. API更新**
- Webhook已更新支持按时长扣费
- 项目创建API使用新的RPC函数

## ⚠️ **注意事项**

1. **向后兼容**: 现有的固定积分记录仍然有效
2. **积分不足**: 系统会扣除所有剩余积分，不会阻止视频完成
3. **错误处理**: 积分扣除失败不会影响视频状态更新
4. **最低要求**: 用户至少需要1-2积分才能启动项目

这个优化方案参考了AI Baby Podcast的成功经验，实现了更加公平和灵活的积分消耗机制。
